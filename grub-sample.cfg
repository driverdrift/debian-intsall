# For latest debian os, it is not recommanded to edit /boot/grub/grub.cfg, 
# because it is automatically generated by grub-mkconfig using templates 
# from /etc/grub.d and settings from /etc/default/grub
# You can edit /etc/grub.d/40_custom to add your custom menu entries. But be
# careful not to change the 'exec tail' line above. Just write raw menuentry on it rather than script.
# It will automatically add in grub.cfg after run `sudo update-grub` .
# As for windows, chainloader +1 is necessary. Because unlike linux loading kernel and initrd for grub, 
# windows rely on its bootloader which is usually in first sector in system partition called boot sector.
# Run `sudo update-grub` after edit /etc/grub.d/40_custom file.
# menuentry "My Windows 11" {
	# set root='hd0,gpt1'
	# chainloader +1
# }


# Hd-media installer sample
# Hd-media will automatically find iso traversing all the partition and seeking .iso file when booting.
# Declare the isofile_path explicitly such as `linux /boot/vmlinuz iso-scan/filename=\$isofile` won't pass the message to kernel.
# Hd-media only support the matched (latest) iso, the mismatched (older) edition won't find kernel modules during installation.
cat > "$mount_path/boot/grub/grub.cfg" <<EOF
set timeout=5
set default=0
set gfxmode=800x600
set gfxpayload=keep
set isofile="$ISO"

loopback loop \$isofile

# linux	/boot/vmlinuz iso-scan/filename=\$isofile  # This iso-scan option seems do not work in menuentry.
# Ubuntu initramfs/boot support iso-scan option, while debian does not support it.

if [ "\$grub_platform" = "efi" ]; then
	insmod efi_gop
	insmod efi_uga
else
	insmod vbe
	insmod video_bochs
	insmod video_cirrus
	insmod vga
fi
insmod gfxterm
insmod png
echo "Loading bootloader..."
terminal_output gfxterm

if background_image (loop)/isolinux/splash.png; then
  set color_normal=light-gray/black
  set color_highlight=white/black
elif background_image (loop)/splash.png; then
  set color_normal=light-gray/black
  set color_highlight=white/black
else
  set menu_color_normal=cyan/blue
  set menu_color_highlight=white/blue
fi

insmod play
play 960 440 1 0 4 440 1
set theme=(loop)/boot/grub/theme/1

menuentry --hotkey=i 'Install' {
	set background_color=black
	linux	/boot/vmlinuz vga=788 --- quiet 
	initrd	/boot/initrd.gz
}
submenu --hotkey=a 'Advanced options' {
	set menu_color_normal=cyan/blue
	set menu_color_highlight=white/blue
	set theme=(loop)/boot/grub/theme/1-1
	set gfxpayload=keep
	menuentry 'Back' {
		set submenu_stack=pop
	}
	menuentry --hotkey=x 'Expert install' {
		set background_color=black
		linux	/boot/vmlinuz priority=low vga=788 --- 
		initrd	/boot/initrd.gz
	}
	menuentry --hotkey=r 'Rescue mode' {
		set background_color=black
		linux	/boot/vmlinuz vga=788 rescue/enable=true --- quiet 
		initrd	/boot/initrd.gz
	}
	menuentry --hotkey=a 'Automated install' {
		set background_color=black
		linux	/boot/vmlinuz auto=true priority=critical vga=788 --- quiet 
		initrd	/boot/initrd.gz
	}
}
submenu --hotkey=d 'Accessible dark contrast installer menu' {
	set menu_color_normal=white/black
	set menu_color_highlight=yellow/black
	set color_normal=white/black
	set color_highlight=yellow/black
	background_image
	set theme=(loop)/boot/grub/theme/dark-1-2
	set gfxpayload=keep
	menuentry 'Back' {
		set submenu_stack=pop
	}
	menuentry --hotkey=i 'Install' {
		set background_color=black
		linux	/boot/vmlinuz vga=788 theme=dark --- quiet 
		initrd	/boot/initrd.gz
	}
	submenu --hotkey=a 'Advanced options' {
		set menu_color_normal=white/black
		set menu_color_highlight=yellow/black
		set color_normal=white/black
		set color_highlight=yellow/black
		background_image
		set theme=(loop)/boot/grub/theme/dark-1-2-1
		set gfxpayload=keep
		menuentry 'Back' {
			set submenu_stack=pop
		}
		menuentry --hotkey=x 'Expert install' {
			set background_color=black
			linux	/boot/vmlinuz priority=low vga=788 theme=dark --- 
			initrd	/boot/initrd.gz
		}
		menuentry --hotkey=r 'Rescue mode' {
			set background_color=black
			linux	/boot/vmlinuz vga=788 rescue/enable=true theme=dark --- quiet 
			initrd	/boot/initrd.gz
		}
		menuentry --hotkey=a 'Automated install' {
			set background_color=black
			linux	/boot/vmlinuz auto=true priority=critical vga=788 theme=dark --- quiet 
			initrd	/boot/initrd.gz
		}
	}
}
EOF

# Loop mode sample
# Loop mode doesn't support for debian-netinst.iso, because the vmlinuz file couldn't find iso file from a partition.
# As for loop boot.img gunzipped from hd-media/boot.img.gz, it must match the proper debian-netinst.iso with the same kernel vision, otherwise it will not find kernel modules in debian-netinst.iso which are needed for an installation. Because boot.img is euqal to boot from vmlinuz & initrd.gz, they are not whole things including net-module and others.
# Cat will add a blank line to the end automatically.
cat > "$mount_path/boot/grub/grub.cfg" <<EOF
set timeout=5
set default=0
set isofile="$path_to_iso_or_img"

# For live-iso, use `linux (loop)/live/vmlinuz boot=live` optition in menuentry to in case of kernel panic.

menuentry --hotkey=i "Install" {
	set background_color=black
	loopback loop \$isofile
	linux		(loop)/install.amd/vmlinuz vga=788 --- quiet 
	# linux		(loop)/linux vga=788 --- quiet   # For hd-media/boot.img
	initrd		(loop)/install.amd/initrd.gz
	# initrd	(loop)/initrd.gz  # For hd-media/boot.img
}
submenu --hotkey=a 'Advanced options' {
	set menu_color_normal=cyan/blue
	set menu_color_highlight=white/blue
	set theme=/boot/grub/theme/1-1
	set gfxpayload=keep
	menuentry --hotkey=x 'Expert install' {
		set background_color=black
		loopback loop \$isofile
		linux		(loop)/install.amd/vmlinuz priority=low vga=788 --- quiet 
		# linux		(loop)/linux priority=low vga=788 --- quiet   # For hd-media/boot.img
		initrd		(loop)/install.amd/initrd.gz
		# initrd	(loop)/initrd.gz  # For hd-media/boot.img
	}
}
EOF
